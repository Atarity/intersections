#!/bin/sh -e

# Intersections - A simple bash-based static site generator for links
# Usage: ./intersections "url" "comment"

domain="https://snnkv.com/"
ts=$(date '+%Y-%m-%d')
rssdate=$(date +"%a, %d %b %Y %H:%M:%S +0000")
url_original=$1
comment=$2

if [ -z "$url_original" ]; then
    echo "Usage: ./intersections <url> [comment]"
    exit 1
fi

# Normalize URL for display (strip protocols and www)
url_display=$(echo "$url_original" | sed -E 's|^https?://||; s|^www\.||; s|/$||')

# Fetch title from target page (limited to 5 seconds, follow redirects)
fetch_title() {
    title=$(curl -sL --max-time 5 "$1" | xmllint --html --xpath "string(//title)" - 2>/dev/null | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    # Cleanup entities and extra whitespace
    echo "$title" | sed -E 's/<[^>]*>//g; s/&[a-z0-9#]+;//g' | cut -c 1-200
}

echo "Fetching title for $url_original..."
page_title=$(fetch_title "$url_original")

# Fallback if title is empty
if [ -z "$page_title" ]; then
    page_title="$url_display"
fi

# Prepare HTML entry for timeline.htm
echo "<article id='$url_display'>
  <div class='entry-header'>
    <span class='ts'>$ts</span>
    <h2 class='entry-title'>$page_title</h2>
    <a href='$url_original' class='url' target='_blank'>$url_display</a>
  </div>
  <p class='comment'>$comment</p>
</article>" > meta/last.htm

# Prepend last entry to timeline.htm
touch meta/timeline.htm
cat meta/last.htm meta/timeline.htm > meta/_timeline.htm
mv meta/_timeline.htm meta/timeline.htm

# Assemble index.html
rm -f index.html
cat meta/header.htm meta/timeline.htm meta/footer.htm > index.html

# Prepare RSS item (inlined echo)
cat <<EOF > meta/rss_last.tmpl
<item>
  <title>$page_title</title>
  <link>$url_original</link>
  <description>$comment</description>
  <pubDate>$rssdate</pubDate>
  <guid>$url_original</guid>
</item>
EOF

# Prepend last RSS item to rss_timeline.tmpl
touch meta/rss_timeline.tmpl
cat meta/rss_last.tmpl meta/rss_timeline.tmpl > meta/_rss_timeline.tmpl
mv meta/_rss_timeline.tmpl meta/rss_timeline.tmpl

# Assemble feed.xml (Top 20 items)
rm -f feed.xml
cat meta/rss_header.tmpl > feed.xml
echo "  <lastBuildDate>$rssdate</lastBuildDate>" >> feed.xml

# Take top 20 items (roughly 7 lines per item)
awk '/<item>/ { c++ } c <= 20' meta/rss_timeline.tmpl >> feed.xml

echo "</channel>\n</rss>" >> feed.xml

echo "-------"
echo "Title: $page_title"
echo "Link added: $url_display"
echo "Comment: $comment"
echo "index.html and feed.xml updated."

# Auto-commit and push as in "decades"
##if [ -d .git ]; then
##    git status --short && git add -A && git commit -m "Add link: $url_display"
##    git push # Commented out by default as per user request in decades README dry run
##fi
